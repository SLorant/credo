---
export const prerender = true; // Makes this page static for better SEO and performance

import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import Header from "../components/header/Header.astro";
import Image from "astro/components/Image.astro";
import ArrowButton from "../components/general/ArrowButton.astro";
import PageLanding from "../components/general/PageLanding.astro";
import Contact from "../components/general/Contact.astro";

const projects = await getCollection("projects");
const options = [
  "Mutasd mindet",
  "Performance",
  "Creative",
  "Digital",
  "Production",
];
---

<Layout>
  <Header />

  <div class="container">
    <img class="m" src="/herogradient2.png" alt="Gradient" />
    <img class="m" id="parallax-hand" src="/kezproba.webp" alt="Hand" />
    <img class="m" id="phone" src="/munkaink_phone.webp" alt="Hand" />
    <img class="m" src="/csakfekete.png" />
    <main>
      <PageLanding
        header1="kiemelt"
        header2="munkáink"
        text={`Minden partnerünk más iparágból érkezik, de a kihívás közös: érvényesülni
a zajban. Tudjuk, hogy a stratégia csak hipotézis az éles bevetésig, és
a versenyben ma már nem a leghangosabb nyer, hanem a leghitelesebb.
<br/><br/>
Portfóliónk darabjai egyedi válaszok a speciális piaci helyzetekre, melyeket
a stratégiai élesség és a gondos, kreatív kivitelezés köt össze. Így válnak
a brandek egyszerű felületekből emlékezetes élménnyé.`}
      />
      <div class="options" id="filteroptions-container">
        {
          options.map((opt) => (
            <div class="optionbox" data-option={opt}>
              {opt}
            </div>
          ))
        }
      </div>
      <div class="cardcont">
        {
          projects.map((project) => (
            <div
              class="card"
              data-categories={JSON.stringify(project.data.category)}
            >
              <div class="c">
                <h2>{project.data.title}</h2>
                <div class="up">
                  <p>{project.data["card-subheadline"]}</p>
                  <a href={`/munkaink/${project.id}`}>
                    <ArrowButton text="NÉZD MEG!" />
                  </a>
                </div>
              </div>

              <Image
                alt={"Side Image"}
                src={project.data["cover"]}
                layout="constrained"
                class={"cardImg"}
              />
            </div>
          ))
        }
      </div>
    </main>
  </div>
  <Contact />
</Layout>

<script>
  import { animate } from "motion";

  const optionsContainer = document.getElementById("filteroptions-container");
  const selectedOptions = new Set<string>();
  const showAll = "Mutasd mindet";

  // Check URL for filter parameter
  const urlParams = new URLSearchParams(window.location.search);
  const filterParam = urlParams.get("filter");

  if (filterParam) {
    // Capitalize first letter to match option names
    const filterValue =
      filterParam.charAt(0).toUpperCase() + filterParam.slice(1).toLowerCase();
    selectedOptions.add(filterValue);

    // Update UI to reflect the selected filter
    document.querySelectorAll(".optionbox").forEach((box) => {
      const option = (box as HTMLElement).dataset.option;
      if (option === filterValue) {
        box.classList.add("selected");
      }
    });
  } else {
    selectedOptions.add(showAll);
    document.querySelector(".optionbox")?.classList.add("selected");
  }

  // Adjust h2 translateY based on paragraph line count
  function adjustCardHeadings() {
    const cards = document.querySelectorAll(".card") as NodeListOf<HTMLElement>;
    cards.forEach((card) => {
      const paragraph = card.querySelector(".c p") as HTMLElement;
      const heading = card.querySelector(".card h2") as HTMLElement;

      if (paragraph && heading) {
        const lineHeight = parseFloat(getComputedStyle(paragraph).lineHeight);
        const height = paragraph.offsetHeight;
        const lineCount = Math.round(height / lineHeight);

        // Adjust translateY based on line count
        if (lineCount === 1 && window.innerWidth < 768) {
          heading.style.setProperty("--translate-y", "60px");
        } else if (lineCount === 1) {
          heading.style.setProperty("--translate-y", "100px");
        } else if (window.innerWidth < 768) {
          heading.style.setProperty("--translate-y", "75px");
        } else {
          heading.style.setProperty("--translate-y", "130px");
        }
      }
    });
  }

  // Animate cards on initial load
  const cards = document.querySelectorAll(".card") as NodeListOf<HTMLElement>;
  cards.forEach((card, index) => {
    animate(
      card,
      { opacity: [0, 1] },
      { duration: 0.5, delay: 0.5 + index * 0.05 },
    );
  });

  // Adjust headings after cards are visible
  setTimeout(adjustCardHeadings, 600);

  // Re-adjust on window resize
  window.addEventListener("resize", adjustCardHeadings);

  // Filter cards based on selected options
  function filterCards() {
    const cards = document.querySelectorAll(".card") as NodeListOf<HTMLElement>;

    cards.forEach((card) => {
      const categoriesAttr = card.dataset.categories;
      if (!categoriesAttr) return;

      const categories = JSON.parse(categoriesAttr) as string[];
      const shouldShow =
        selectedOptions.has(showAll) ||
        categories.some((cat) => selectedOptions.has(cat));

      if (shouldShow) {
        card.classList.remove("hidden");
      } else {
        card.classList.add("hidden");
      }
    });
  }

  // Run initial filter if there's a URL parameter
  if (filterParam) {
    filterCards();

    // Scroll to options section after a brief delay to ensure page is loaded
    setTimeout(() => {
      const optionsSection = document.getElementById("filteroptions-container");
      if (optionsSection) {
        optionsSection.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    }, 100);
  }

  // Handle option selection
  optionsContainer?.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;
    if (target.classList.contains("optionbox")) {
      const option = target.dataset.option;
      if (option) {
        if (selectedOptions.has(option) && option !== showAll) {
          selectedOptions.delete(option);
          target.classList.remove("selected");

          if (selectedOptions.size === 0) {
            selectedOptions.add(showAll);
            document.querySelector(".optionbox")?.classList.add("selected");
          }
        } else if (option === showAll) {
          selectedOptions.clear();
          selectedOptions.add(option);
          document.querySelectorAll(".optionbox").forEach((box) => {
            if (box !== target) {
              box.classList.remove("selected");
            }
          });
          target.classList.add("selected");
        } else if (option !== showAll) {
          selectedOptions.delete(showAll);
          selectedOptions.add(option);
          document.querySelector(".optionbox")?.classList.remove("selected");
          target.classList.add("selected");
        }

        filterCards();
      }
    }
  });

  const parallaxHand = document.getElementById("parallax-hand");

  document.addEventListener("mousemove", (e) => {
    const xPos = (e.clientX / window.innerWidth - 0.5) * 20;
    const yPos = (e.clientY / window.innerHeight - 0.5) * 20;

    if (parallaxHand) {
      parallaxHand.style.transform = ` translate(${xPos}px, ${yPos}px)`;
    }
  });
</script>

<style>
  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }

  /*  body {
    overflow-x: hidden;
    overscroll-behavior: none;
  } */

  .container {
    width: 100%;
    padding: 6rem 0;
    color: white;
    font-family: "AktivGrotesk Regular";
    background: radial-gradient(
      circle,
      rgb(36, 36, 43) 0%,
      rgba(0, 0, 0, 1) 0%
    );
    margin: 0 auto;
    overflow-x: hidden;
  }
  main {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    overflow: hidden;
    position: relative;
  }
  .options {
    padding-top: 100px;
    padding-left: 5px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px 20px;
    width: 100%;
    opacity: 1;
    transition:
      opacity 0.5s ease,
      transform 0.5s ease;
  }

  .optionbox {
    padding: 8px 20px;
    border-radius: 30px;
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    color: white;
    display: flex;
    justify-content: center;
    place-items: center;
    border: 2px solid white;
    text-transform: uppercase;
    font-size: var(--text-base);
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    font-family: "AktivGrotesk Regular";
  }
  .optionbox:hover {
    background: rgb(255 255 255 / 0.1);
    transform: scale(1.05);
  }
  .optionbox.selected {
    background: #dbe120;
    color: #1c1b22;
    border-color: #dbe120;
  }

  .cardcont {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 30px;
    margin-top: 50px;
  }
  .card {
    width: 100%;
    border-radius: 40px;
    position: relative;
    overflow: hidden;
    opacity: 0;
    transition: opacity 0.4s ease;
  }
  .card.hidden {
    display: none;
  }
  .m {
    width: 100vw;
    height: 100vh;
    position: absolute;
    top: 0;
    left: 0;
    overflow: hidden;
  }
  #parallax-hand {
    height: 102vh;
    top: -3vh;
    left: 0;
    width: 100vw;
    transition: transform 0.1s ease-out;
    aspect-ratio: 16 / 9 !important;
    object-fit: cover;
  }
  #phone {
    display: none;
  }

  .cardImg {
    aspect-ratio: 16 / 9;
    height: auto;
    border-radius: 40px;
    filter: brightness(0.6);
    opacity: 1;
    transition: all;
    transition-duration: 300ms;
  }
  .card:hover .cardImg {
    filter: brightness(0.3);
    transform: scale(1.1);
  }
  .card:hover .up {
    opacity: 1;
  }

  .card .c {
    color: white;
    font-family: "AktivGrotesk Regular";
    position: absolute;
    bottom: 0rem;
    right: 0rem;
    width: 100%;
    height: 100%;
    z-index: 40;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: start;
    padding-left: 2rem;
    padding-bottom: 2rem;
    transition: padding-bottom 300ms ease;
  }
  .up {
    opacity: 0;
    transition: all 300ms ease;
    max-width: 50%;
    padding-left: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    text-transform: uppercase;
  }
  a {
    text-decoration: none;
    color: white;
  }

  .card h2 {
    margin: 0;
    color: white;
    font-family: "AktivGrotesk Regular";
    font-size: var(--header-sm);
    line-height: 3rem;
    z-index: 40;
    font-weight: 400;
    transition: all 300ms ease;
    max-width: 70%;
    text-align: left;
    transform: translateY(var(--translate-y, 130px));
  }
  .card:hover h2 {
    margin-bottom: 1rem;
    transform: translateY(0px);
  }
  .c p {
    transition: all 300ms ease;
    font-size: var(--text-lg);
    line-height: 2rem;
    margin: 0;
  }
  .c a {
    transition: all 300ms ease;
  }
  .card:hover .c {
    padding-bottom: 2rem;
  }

  @media (max-width: 1400px) {
    #parallax-hand {
      left: -20%;
      width: 120vw;
    }
  }

  @media (max-width: 1300px) {
    .cardcont {
      max-width: 1000px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 50px;
    }
    .options {
      max-width: 1000px;
      margin: 0 auto;
      margin-top: 100px;
    }
    .card:hover h2 {
      transform: translateY(10px);
    }
    .card:hover .c {
      padding-bottom: 1rem;
    }
    .card {
      width: 100%;
    }
    .card h2 {
      font-size: var(--header-sm2);
      line-height: 2.5rem;
      transform: translateY(var(--translate-y, 130px));
      max-width: 100%;
    }

    .c p {
      transition: all 300ms ease;
      font-size: var(--text-md);
      line-height: 2rem;
      margin: 0;
    }
  }

  @media (max-width: 1200px), (max-height: 800px) {
    #parallax-hand {
      left: -40%;
      width: 180vw;
      transform: translateX(-50%);
    }
  }

  @media (max-width: 1050px) {
    .cardcont {
      max-width: 700px;
      grid-template-columns: repeat(1, 1fr);
      gap: 30px;
    }
    .options {
      max-width: 700px;
      margin: 0 auto;
      margin-top: 100px;
    }
    .card:hover h2 {
      transform: translateY(0px);
    }
    .card:hover .c {
      padding-bottom: 3rem;
    }
    .card {
      width: 100%;
    }
    .card h2 {
      font-size: var(--header-sm2);
      line-height: 2.5rem;
      transform: translateY(var(--translate-y, 120px));
    }
    .c p {
      transition: all 300ms ease;
      font-size: var(--text-lg);
      line-height: 2rem;
      margin: 0;
    }
  }

  @media (max-width: 768px) {
    #parallax-hand {
      display: none;
    }
    .container {
      padding-bottom: 3rem;
    }
    .cardcont {
      max-width: 85%;
      grid-template-columns: repeat(1, 1fr);
      gap: 20px;
      margin-top: 30px;
    }
    .options {
      max-width: 80%;
      margin-top: 50px;
      gap: 20px 10px;
    }
    .optionbox {
      padding: 8px 14px;
      border-radius: 30px;
      font-size: var(--text-sm);
      border: 1px solid white;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      font-family: "AktivGrotesk Regular";
    }
    .card:hover h2 {
      transform: translateY(5px);
    }
    .card:hover .c {
      padding-bottom: 1rem;
    }
    .up {
      max-width: 80%;
    }
    .card .c {
      padding-left: 1.5rem;
      padding-bottom: 0rem;
    }
    .card {
      width: 100%;
    }
    .card h2 {
      font-size: var(--header-xs);
      line-height: 2rem;
      transform: translateY(var(--translate-y, 75px));
      margin-left: 5px;
      /*    transform: translateY(75px); */
    }
    .c p {
      transition: all 300ms ease;
      font-size: var(--text-base);
      line-height: 1.2rem;
      margin: 0;
    }
    #phone {
      height: 102vh;
      top: -3vh;
      left: 0;
      transition: transform 0.1s ease-out;
      aspect-ratio: 16 / 9 !important;
      object-fit: cover;
      opacity: 0.8;
      display: block;
    }
  }

  /* IMG */

  :where([data-astro-image]) {
    object-fit: var(--fit);
    object-position: var(--pos);
  }
  :where([data-astro-image="full-width"]) {
    width: 100%;
  }
  :where([data-astro-image="constrained"]) {
    max-width: 100%;
  }

  /* ---------------------- */
</style>
